<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Ali's Chat Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ADDED MISSING LOADING SCREEN STYLES */
        #global-loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: #FF33CC;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* RESTORED VISIBLE ELEMENTS */
        .container {
            /* Previous container styles */
            opacity: 1 !important; /* Force visibility */
        }

        /* FIXED HIDDEN ELEMENT INITIAL STATES */
        #chat-input-area {
            display: none; /* Should be hidden initially */
        }

        #handle-screen {
            display: flex; /* Should be visible initially */
        }
    </style>
</head>
<body>
    <!-- RESTORED MISSING LOADING SCREEN MARKUP -->
    <div id="global-loading-screen">
        <p>Connecting to chat server...</p>
    </div>

    <!-- RESTORED VISIBLE CONTAINER STRUCTURE -->
    <div class="container">
        <div class="header">
            Ali's Chat Room
            <div class="connection-status">Status: connecting...</div>
        </div>
        
        <!-- CHAT LOG WITH INITIAL CONTENT -->
        <div class="chat-log" id="chat-log">
            <div class="system-message">Chat initialized...</div>
        </div>

        <!-- HANDLE INPUT SCREEN -->
        <div id="handle-screen">
            <div class="handle-form">
                <label for="user-handle">Enter your handle:</label>
                <input type="text" id="user-handle" placeholder="Chat handle...">
                <button onclick="enterChat()">Join Chat</button>
            </div>
        </div>

        <!-- CHAT INPUT AREA -->
        <div id="chat-input-area">
            <input type="text" id="chat-input" class="chat-input">
            <button class="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

<script>
// UPDATED INITIALIZATION SEQUENCE
document.addEventListener('DOMContentLoaded', () => {
    // Show loading screen immediately
    document.getElementById('global-loading-screen').style.display = 'flex';
    
    // Initialize WebSocket connection
    connectWebSocket();

    // Check for existing handle
    const savedHandle = localStorage.getItem('userHandle');
    if(savedHandle) {
        document.getElementById('user-handle').value = savedHandle;
    }
});

// MODIFIED WEBSOCKET HANDLING
function connectWebSocket() {
    const loadingScreen = document.getElementById('global-loading-screen');
    
    try {
        socket = new WebSocket('wss://wave-sand-raisin.glitch.me');

        socket.onopen = () => {
            loadingScreen.style.display = 'none';
            document.getElementById('handle-screen').style.display = 'flex';
            updateConnectionStatus('connected');
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                // Handle different message types
                if(data.type === 'history') {
                    handleHistory(data.messages);
                } else if(data.type === 'message') {
                    appendMessage(data);
                }
            } catch(e) {
                console.error('Message parsing error:', e);
            }
        };

        socket.onclose = () => {
            loadingScreen.style.display = 'flex';
            updateConnectionStatus('disconnected');
            setTimeout(connectWebSocket, 5000);
        };

        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
            updateConnectionStatus('error');
        };

    } catch(error) {
        console.error('WebSocket initialization failed:', error);
        loadingScreen.textContent = 'Connection failed - refresh to retry';
    }
}

// ADDED VISIBLE MESSAGE HANDLING
function appendMessage(data) {
    const chatLog = document.getElementById('chat-log');
    const messageDiv = document.createElement('div');
    
    messageDiv.innerHTML = `
        <span style="color: ${data.color}">${data.handle}:</span>
        <span style="color: #33FFA1">${escapeHTML(data.content)}</span>
    `;
    
    chatLog.appendChild(messageDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
}

// BASIC MESSAGE HISTORY HANDLING
function handleHistory(messages) {
    const chatLog = document.getElementById('chat-log');
    chatLog.innerHTML = ''; // Clear loading message
    messages.forEach(appendMessage);
}

// RESTORED MISSING HELPER FUNCTIONS
function escapeHTML(str) {
    return str.replace(/&/g, '&amp;')
             .replace(/</g, '&lt;')
             .replace(/>/g, '&gt;');
}

function updateConnectionStatus(status) {
    const statusElement = document.querySelector('.connection-status');
    if(statusElement) {
        statusElement.textContent = `Status: ${status}`;
        statusElement.style.color = 
            status === 'connected' ? '#0F0' :
            status === 'disconnected' ? '#F00' : '#FF0';
    }
}

// ENSURE THESE FUNCTIONS ARE GLOBAL
window.enterChat = function() {
    const handle = document.getElementById('user-handle').value.trim();
    if(handle.length < 1 || handle.length > 20) {
        alert('Handle must be 1-20 characters');
        return;
    }
    
    localStorage.setItem('userHandle', handle);
    document.getElementById('handle-screen').style.display = 'none';
    document.getElementById('chat-input-area').style.display = 'block';
    document.getElementById('chat-input').focus();
};

window.sendMessage = function() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if(message && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'message',
            content: message,
            handle: localStorage.getItem('userHandle'),
            color: localStorage.getItem('handleColor') || '#FF33CC'
        }));
        input.value = '';
    }
};
</script>
</body>
</html>
