<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Web Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* 1990s-ish defaults: grey page, simple borders, system fonts */
    html, body { height: 100%; }
    body {
      margin: 0; padding: 20px;
      background: #c0c0c0;
      color: #000;
      font-family: Arial, Helvetica, sans-serif;
    }
    .wrap {
      width: 680px; max-width: 100%;
      margin: 0 auto; background: #ffffff;
      border: 1px solid #999;
    }
    .bar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 10px; border-bottom: 1px solid #ccc;
      background: #f2f2f2; font-size: 12px;
    }
    .bar .status { color: #333; }
    .bar .room { color: #555; }
    #log {
      height: 380px; overflow-y: auto; padding: 10px;
      background: #fff; font-family: "Courier New", Courier, monospace; font-size: 13px;
      line-height: 1.3; white-space: pre-wrap; word-break: break-word;
      border-bottom: 1px solid #ccc;
    }
    .controls { padding: 10px; }
    .row { display: flex; gap: 6px; margin-bottom: 6px; }
    label { font-size: 12px; color: #333; }
    input[type="text"] {
      flex: 1; padding: 6px; border: 1px solid #999; font-family: Arial, Helvetica, sans-serif; font-size: 13px;
      background: #fff; color: #000;
    }
    input[name="nick"] { flex: 0 0 180px; }
    button {
      padding: 6px 10px; border: 1px solid #666; background: #e6e6e6; color: #000;
      font-size: 13px; cursor: pointer;
    }
    button:active { background: #d9d9d9; }
    .hint { font-size: 11px; color: #666; padding: 0 10px 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="status" id="status">Connectingâ€¦</div>
      <div class="room" id="roomLabel"></div>
    </div>

    <div id="log" aria-live="polite"></div>

    <div class="controls">
      <div class="row">
        <label for="nick" style="align-self:center;">Nick:</label>
        <input type="text" id="nick" name="nick" maxlength="24" placeholder="Your name">
        <button id="saveNick" title="Save nick">Set</button>
      </div>
      <div class="row">
        <input type="text" id="msg" placeholder="Type message">
        <button id="send">Send</button>
      </div>
    </div>
    <div class="hint">
      Tip: Press Enter to send. Open this page in two tabs with the same <code>?room=</code> value to test.
    </div>
  </div>

  <script>
    // ===== Config =====
    // If your Worker hostname is different, change this value.
    const WORKER_HOST = "chat.asalmaadeed.workers.dev";

    // Room from ?room=... (default "lobby")
    const ROOM = new URL(location.href).searchParams.get("room") || "lobby";
    document.getElementById("roomLabel").textContent = "Room: " + ROOM;

    // Nickname stored locally
    const NICK_KEY = "chat_nick";
    let nick = localStorage.getItem(NICK_KEY) || ("User" + Math.floor(Math.random()*1000));
    const $ = id => document.getElementById(id);
    $("nick").value = nick;

    $("saveNick").onclick = () => {
      const v = $("nick").value.trim();
      if (!v) return;
      nick = v.slice(0, 24);
      localStorage.setItem(NICK_KEY, nick);
      appendLine("* nick set to " + nick);
    };

    // WebSocket helpers
    let ws;
    function wsUrl() {
      return "wss://" + WORKER_HOST + "/room/" + encodeURIComponent(ROOM);
    }
    function setStatus(s) { $("status").textContent = s; }

    function connect() {
      try {
        ws = new WebSocket(wsUrl());
      } catch (e) {
        setStatus("Error");
        return;
      }
      setStatus("Connecting");
      ws.onopen = () => setStatus("Online");
      ws.onclose = () => { setStatus("Disconnected"); setTimeout(connect, 1200); };
      ws.onerror = () => { setStatus("Error"); try { ws.close(); } catch {} };
      ws.onmessage = onMessage;
    }

    function sendPlain() {
      const input = $("msg");
      const text = input.value.trim();
      if (!text || !ws || ws.readyState !== 1) return;
      const payload = { username: nick, color: "hsl(0,0%,0%)", text };
      try { ws.send(JSON.stringify(payload)); } catch {}
      input.value = "";
    }

    $("send").onclick = sendPlain;
    $("msg").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendPlain();
      }
    });

    // Rendering
    function appendLine(text) {
      const log = $("log");
      const line = document.createElement("div");
      line.textContent = text;     // safe text insertion
      log.appendChild(line);
      log.scrollTop = log.scrollHeight;
    }

    function formatTime(ms) {
      try {
        const d = new Date(ms || Date.now());
        return d.toLocaleTimeString();
      } catch { return ""; }
    }

    function renderMessage(m) {
      const time = formatTime(m.time);
      const name = m.username || "Anon";
      const line = "[" + time + "] <" + name + "> " + (m.text || "");
      appendLine(line);
    }

    async function onMessage(event) {
      let payload;
      try { payload = JSON.parse(event.data); } catch { return; }

      if (payload.type === "history" && Array.isArray(payload.data)) {
        for (const m of payload.data) renderMessage(m);
        return;
      }
      renderMessage(payload);
    }

    // Start
    connect();
  </script>
</body>
</html>
