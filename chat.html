<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Ali's Chat Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --user-color: #FF33CC;
        }

        body {
            background-color: black;
            background-image: url('stars.gif');
            font-family: 'Press Start 2P', cursive;
            color: var(--user-color);
        }

        .container {
            position: relative;
            width: 90%;
            max-width: 600px;
            margin: auto;
            padding: 20px;
            background-color: #000;
            border: 2px solid var(--user-color);
            margin-top: 50px;
            box-shadow: 0 0 10px var(--user-color);
        }

        .header {
            background-color: var(--user-color);
            color: #FFF;
            padding: 10px;
            text-align: center;
            font-size: 1.5em;
            position: relative;
        }

        .connection-status {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6em;
        }

        .chat-log {
            height: 300px;
            width: 100%;
            border: 1px solid var(--user-color);
            padding: 5px;
            margin: 10px 0;
            overflow-y: scroll;
            background-color: #000;
            color: #33FFA1;
            font-family: 'Press Start 2P', cursive;
            white-space: pre-wrap;
            role: "log";
            aria-live: "polite";
        }

        .chat-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #333;
            border: 1px solid var(--user-color);
            color: #FFF;
            box-sizing: border-box;
        }

        .send-button {
            width: 100%;
            padding: 8px;
            background-color: var(--user-color);
            color: #FFF;
            border: none;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 480px) {
            .container {
                margin-top: 20px;
                padding: 10px;
            }
            
            .chat-log {
                height: 200px;
                font-size: 0.8em;
            }
        }

        /* Keep existing styles for other elements */
        /* ... */
    </style>
</head>
<body>
    <!-- Keep existing HTML structure -->
    <!-- ... -->

    <script>
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const escapeHTML = str => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        function connectWebSocket() {
            const chatLoadingScreen = document.querySelector('#loading-screen');
            chatLoadingScreen.style.display = 'block';

            socket = new WebSocket('wss://wave-sand-raisin.glitch.me');

            socket.addEventListener('open', () => {
                reconnectAttempts = 0;
                chatLoadingScreen.style.display = 'none';
                updateConnectionStatus('connected');
                
                const handle = localStorage.getItem('userHandle');
                const color = localStorage.getItem('handleColor');
                if (handle && isValidColor(color)) {
                    socket.handle = handle;
                    socket.color = color;
                    sendSystemMessage({ type: "auth", handle, color });
                }
            });

            socket.addEventListener('message', event => {
                try {
                    const data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'history':
                            handleHistory(data.messages);
                            break;
                        case 'message':
                            appendMessage(data);
                            break;
                        case 'error':
                            showError(data.message);
                            break;
                    }
                } catch (error) {
                    console.error('Message handling error:', error);
                }
            });

            socket.addEventListener('close', () => {
                updateConnectionStatus('disconnected');
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(connectWebSocket, Math.min(1000 * (2 ** reconnectAttempts), 10000));
                    reconnectAttempts++;
                }
            });

            socket.addEventListener('error', error => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('error');
            });
        }

        function handleHistory(messages) {
            const chatLog = document.getElementById('chat-log');
            chatLog.innerHTML = '';
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.style.color = msg.color;
                div.textContent = `${escapeHTML(msg.handle)}: ${escapeHTML(msg.content)}`;
                chatLog.appendChild(div);
            });
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function appendMessage(data) {
            const chatLog = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.style.color = data.color;
            div.textContent = `${escapeHTML(data.handle)}: ${escapeHTML(data.content)}`;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function sendSystemMessage(message) {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            }
        }

        function enterChat() {
            const handleInput = document.getElementById('user-handle');
            const handle = handleInput.value.trim();
            
            if (!/^[\w-]{1,20}$/.test(handle)) {
                showError('Handle must be 1-20 characters (letters, numbers, _-)');
                return;
            }

            const color = getRandomColor();
            localStorage.setItem('userHandle', handle);
            localStorage.setItem('handleColor', color);

            document.documentElement.style.setProperty('--user-color', color);
            document.getElementById('handle-screen').style.display = 'none';
            document.getElementById('chat-input-area').style.display = 'block';
            document.getElementById('chat-input').focus();

            if (socket.readyState === WebSocket.OPEN) {
                sendSystemMessage({ type: "auth", handle, color });
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "message",
                    handle: localStorage.getItem('userHandle'),
                    color: localStorage.getItem('handleColor'),
                    content: message
                }));
                input.value = '';
            }
        }

        function getRandomColor() {
            return `hsl(${Math.random() * 360}, 70%, 60%)`;
        }

        function isValidColor(color) {
            return /^(#[0-9A-F]{6}|hsl\(\d{1,3},\s*\d{1,3}%,\s*\d{1,3}%\))$/i.test(color);
        }

        function updateConnectionStatus(status) {
            const statusElement = document.querySelector('.connection-status');
            if (!statusElement) return;

            statusElement.textContent = `Status: ${status}`;
            statusElement.style.color = 
                status === 'connected' ? '#0F0' :
                status === 'disconnected' ? '#F00' : '#FF0';
        }

        function showError(message) {
            const chatLog = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.style.color = '#FF0000';
            div.textContent = `Error: ${message}`;
            chatLog.appendChild(div);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // Event listeners
        document.getElementById('chat-input').addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedColor = localStorage.getItem('handleColor');
            if (savedColor && isValidColor(savedColor)) {
                document.documentElement.style.setProperty('--user-color', savedColor);
            }
            connectWebSocket();
        });
    </script>
</body>
</html>
