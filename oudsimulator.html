<!DOCTYPE html>
<html>
<head>
    <title>Virtual Oud Player</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(45deg, #1a1a1a, #2c3e50);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
        }

        #start {
            padding: 15px 40px;
            font-size: 1.3em;
            background: #d4af37;
            border: none;
            border-radius: 25px;
            color: #2c1b0a;
            cursor: pointer;
            margin: 20px;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .loading {
            color: #d4af37;
            font-size: 1.2em;
            margin: 30px;
            display: none;
        }

        .controls {
            background: rgba(52, 73, 94, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: #ecf0f1;
            width: 80%;
            max-width: 600px;
            display: none;
        }

        .oud-body {
            width: 500px;
            height: 600px;
            background: #8b4513;
            border-radius: 20% 20% 40% 40%;
            position: relative;
            margin: 30px 0;
            display: none;
        }

        .string {
            position: absolute;
            width: 2px;
            background: #d4af37;
            height: 80%;
            top: 12%;
            transform-origin: top;
            cursor: pointer;
        }

        .string:nth-child(1) { left: 12%; }
        .string:nth-child(2) { left: 26%; }
        .string:nth-child(3) { left: 40%; }
        .string:nth-child(4) { left: 54%; }
        .string:nth-child(5) { left: 68%; }
        .string:nth-child(6) { left: 82%; }
    </style>
</head>
<body>
    <button id="start">üéµ Initialize Oud Player</button>
    <div class="loading">üîÑ Loading Oud Samples...</div>

    <div class="controls">
        <div class="control-group">
            <label>üîà Volume</label>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5">
        </div>
        <div class="control-group">
            <label>üéöÔ∏è Tuning</label>
            <input type="range" id="tune" min="0.8" max="1.2" step="0.01" value="1">
        </div>
    </div>

    <div class="oud-body">
        <div class="string"></div>
        <div class="string"></div>
        <div class="string"></div>
        <div class="string"></div>
        <div class="string"></div>
        <div class="string"></div>
    </div>

    <script>
        const sampleURL = 'https://upload.wikimedia.org/wikipedia/commons/7/77/Oud_open_Strings.ogg';
        const stringTimes = [
            { start: 0.2, end: 1.0 }, { start: 1.2, end: 2.0 },
            { start: 2.2, end: 3.0 }, { start: 3.2, end: 4.0 },
            { start: 4.2, end: 5.0 }, { start: 5.2, end: 5.75 }
        ];

        document.getElementById('start').addEventListener('click', async () => {
            try {
                console.log('Initialization started');
                const startBtn = document.getElementById('start');
                const loading = document.querySelector('.loading');
                
                // Initial UI state
                startBtn.style.display = 'none';
                loading.style.display = 'block';

                // Initialize audio context
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('AudioContext created');
                
                // Load audio sample
                console.log('Fetching audio sample...');
                const response = await fetch(sampleURL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                console.log('Sample fetched');

                const arrayBuffer = await response.arrayBuffer();
                console.log('Decoding audio...');
                const masterBuffer = await audioContext.decodeAudioData(arrayBuffer);
                console.log('Audio decoded');

                // Initialize audio nodes
                const globalVolume = audioContext.createGain();
                globalVolume.connect(audioContext.destination);
                globalVolume.gain.value = 0.5;

                // Setup controls
                document.getElementById('volume').addEventListener('input', e => {
                    globalVolume.gain.value = e.target.value;
                });

                // Initialize strings
                console.log('Setting up strings...');
                document.querySelectorAll('.string').forEach((string, index) => {
                    let currentSource = null;

                    const playNote = () => {
                        if (currentSource) currentSource.stop();
                        
                        const source = audioContext.createBufferSource();
                        const gainNode = audioContext.createGain();
                        const tune = document.getElementById('tune').value;

                        source.buffer = masterBuffer;
                        source.playbackRate.value = tune;
                        
                        const startTime = stringTimes[index].start;
                        const endTime = stringTimes[index].end;
                        const duration = endTime - startTime;

                        gainNode.gain.setValueAtTime(0.8, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, 
                            audioContext.currentTime + duration * (1/tune));

                        source.connect(gainNode);
                        gainNode.connect(globalVolume);

                        source.start(0, startTime, duration);
                        currentSource = source;
                        string.style.background = '#ffd700';

                        source.addEventListener('ended', () => {
                            string.style.background = '#d4af37';
                        });
                    };

                    string.addEventListener('mousedown', playNote);
                    string.addEventListener('mouseup', () => {
                        if (currentSource) currentSource.stop();
                        string.style.background = '#d4af37';
                    });
                });

                // Show interface
                console.log('Showing interface...');
                loading.style.display = 'none';
                document.querySelector('.controls').style.display = 'block';
                document.querySelector('.oud-body').style.display = 'block';

            } catch (error) {
                console.error('Initialization error:', error);
                document.querySelector('.loading').innerHTML = 
                    `‚ùå Error: ${error.message}<br>Please refresh the page`;
                document.getElementById('start').style.display = 'block';
            }
        });
    </script>
</body>
</html>
